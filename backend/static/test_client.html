<!DOCTYPE html>
<html>
<head>
    <title>Station Arcturus Test Client</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
        }
        #status {
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #00ff00;
            margin-bottom: 20px;
        }
        #beacons {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
        }
        .beacon {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #00ff00;
        }
        .beacon.offline { border-left-color: #ff0000; }
        .beacon.damaged { border-left-color: #ffff00; }
        .beacon.active { border-left-color: #00ff00; }
    </style>
</head>
<body>
    <h1>ðŸš€ Station Arcturus Command Room - Test Client</h1>
    
    <div id="status">
        Connection Status: <span id="connection-status">Connecting...</span>
    </div>
    
    <div id="stats">
        Total Beacons: <span id="total">0</span> | 
        Active: <span id="active">0</span> | 
        Damaged: <span id="damaged">0</span> | 
        Offline: <span id="offline">0</span>
    </div>
    
    <div id="beacons"></div>
    
    <script>
        // Connect to the backend
        const socket = io('http://localhost:8000');
        
        socket.on('connect', () => {
            document.getElementById('connection-status').textContent = 'Connected âœ“';
            document.getElementById('connection-status').style.color = '#00ff00';
        });
        
        socket.on('disconnect', () => {
            document.getElementById('connection-status').textContent = 'Disconnected âœ—';
            document.getElementById('connection-status').style.color = '#ff0000';
        });
        
        // Map backend statuses to UI classes
        const STATUS_MAP = {
            active: 'active',
            inactive: 'offline',
            error: 'damaged'
        };
        const DEFAULT_STATUS_KEY = 'offline';

        socket.on('beacon_update', (data) => {
            console.log('Beacon update received:', data);
            
            const beaconsDiv = document.getElementById('beacons');
            beaconsDiv.innerHTML = '';
            
            // Initialize counters for the UI (keys are what the UI expects)
            let stats = { active: 0, damaged: 0, offline: 0 };

            data.beacons.forEach(beacon => {
                // Map backend status values to UI class/keys using a mapping table
                // backend: 'active' | 'inactive' | 'error'
                // UI expects: 'active' (green), 'offline' (red), 'damaged' (yellow)
                const rawStatus = String(beacon.status || '').toLowerCase();
                let statusKey = STATUS_MAP[rawStatus];

                if (!statusKey) {
                    console.warn('Unknown beacon status from backend:', rawStatus, 'for beacon', beacon.id);
                    statusKey = DEFAULT_STATUS_KEY; // safe fallback
                }

                const div = document.createElement('div');
                div.className = `beacon ${statusKey}`;
                div.innerHTML = `
                    <strong>${beacon.id}</strong> - 
                    Status: ${statusKey} - 
                    Position: (${Number(beacon.x).toFixed(3)}, ${Number(beacon.y).toFixed(3)}, ${Number(beacon.z).toFixed(3)})
                `;
                beaconsDiv.appendChild(div);

                // Safely increment the counter
                stats[statusKey] = (stats[statusKey] || 0) + 1;
            });
            
            document.getElementById('total').textContent = data.beacons.length;
            document.getElementById('active').textContent = stats.active;
            document.getElementById('damaged').textContent = stats.damaged;
            document.getElementById('offline').textContent = stats.offline;
        });
        
        // Test ping every 5 seconds
        setInterval(() => {
            socket.emit('ping');
        }, 5000);
        
        socket.on('pong', (data) => {
            console.log('Pong received:', data);
        });
    </script>
</body>
</html>
